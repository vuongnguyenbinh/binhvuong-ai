---
import { getCollection } from 'astro:content';

// Get latest 8 posts, sorted by publish date
const allPosts = await getCollection('posts', ({ data }) => !data.draft);
const posts = allPosts
  .sort((a, b) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf())
  .slice(0, 8);

// Category color mapping
const categoryColors: Record<string, { bg: string; text: string }> = {
  'ai-automation': { bg: 'purple', text: 'purple' },
  'marketing': { bg: 'blue', text: 'blue' },
  'content': { bg: 'green', text: 'green' },
  'quan-ly-van-hanh': { bg: 'orange', text: 'orange' },
  'deepwork': { bg: 'yellow', text: 'yellow' },
  'reviews-sach': { bg: 'pink', text: 'pink' },
};

const categoryLabels: Record<string, string> = {
  'ai-automation': 'AI & Automation',
  'marketing': 'Marketing',
  'content': 'Content',
  'quan-ly-van-hanh': 'Quản lý & Vận hành',
  'deepwork': 'Deep Work',
  'reviews-sach': 'Reviews Sách',
};

function getCategoryColor(category: string) {
  return categoryColors[category] || { bg: 'gray', text: 'gray' };
}

function formatDate(date: Date): string {
  return date.toLocaleDateString('vi-VN', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
}
---

<section class="py-16 lg:py-24 bg-white dark:bg-charcoal">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-10">
      <div>
        <span class="inline-block px-3 py-1 bg-green-500/10 text-green-500 text-xs font-semibold rounded-full mb-3">
          BÀI VIẾT MỚI NHẤT
        </span>
        <h2 class="text-2xl lg:text-3xl font-bold">Hướng dẫn mới nhất</h2>
      </div>
      <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2" id="categoryTabs">
        <a href="/blog/"
           class="px-4 py-2 text-sm font-medium rounded-lg border border-bv-red text-bv-red bg-bv-red/10 whitespace-nowrap">
          Tất cả
        </a>
        <a href="/blog/ai-automation/"
           class="px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 dark:border-white/10 text-gray-600 dark:text-gray-400 hover:text-bv-red hover:border-bv-red whitespace-nowrap transition-colors">
          AI & Automation
        </a>
        <a href="/blog/marketing/"
           class="px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 dark:border-white/10 text-gray-600 dark:text-gray-400 hover:text-bv-red hover:border-bv-red whitespace-nowrap transition-colors">
          Marketing
        </a>
        <a href="/blog/content/"
           class="px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 dark:border-white/10 text-gray-600 dark:text-gray-400 hover:text-bv-red hover:border-bv-red whitespace-nowrap transition-colors">
          Content
        </a>
        <a href="/blog/deepwork/"
           class="px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 dark:border-white/10 text-gray-600 dark:text-gray-400 hover:text-bv-red hover:border-bv-red whitespace-nowrap transition-colors">
          Deep Work
        </a>
      </div>
    </div>

    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-5">
      {posts.map((post) => {
        const color = getCategoryColor(post.data.category);
        const categoryLabel = categoryLabels[post.data.category] || post.data.category;
        const postUrl = `/blog/${post.data.category}/${post.slug}/`;

        return (
          <article class="group bg-gray-50 dark:bg-charcoal-light/30 border border-gray-200 dark:border-white/5 rounded-xl overflow-hidden hover:border-bv-red/30 transition-all">
            <a href={postUrl} class="block">
              <div class="aspect-[16/9] overflow-hidden">
                <img
                  src={post.data.image || `https://images.unsplash.com/photo-1677442136019-21780ecad995?w=400&q=80`}
                  alt={post.data.imageAlt || post.data.title}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                  loading="lazy"
                />
              </div>
              <div class="p-4">
                <span class={`text-xs text-${color.text}-500 font-medium`}>
                  {categoryLabel}
                </span>
                <h4 class="font-semibold mt-1 mb-2 line-clamp-2 text-sm group-hover:text-bv-red transition-colors">
                  {post.data.title}
                </h4>
                <span class="text-xs text-gray-500">
                  {post.data.readingTime} • {formatDate(new Date(post.data.publishDate))}
                </span>
              </div>
            </a>
          </article>
        );
      })}
    </div>

    {posts.length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">Chưa có bài viết nào.</p>
      </div>
    )}
  </div>
</section>

<style>
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
</style>
