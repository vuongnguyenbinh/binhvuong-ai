---
import { getCollection } from 'astro:content';

// Try to get case studies from Content Collection, fallback to static data
let caseStudies: any[] = [];
try {
  const collection = await getCollection('case-studies');
  caseStudies = collection.slice(0, 4);
} catch (e) {
  // Use static data if collection doesn't exist yet
}

// Static fallback data
const staticCaseStudies = [
  {
    slug: 'phong-kham-abc',
    title: 'Phòng khám ABC',
    industry: 'Y TẾ',
    industryColor: 'green',
    description: 'Tăng 200% lead trong 3 tháng với AI Chatbot',
    image: 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=600&q=80',
    metrics: [
      { value: '+200%', label: 'Lead tăng', color: 'green' },
      { value: '-10h', label: 'Tiết kiệm/tuần', color: 'green' }
    ]
  },
  {
    slug: 'trung-tam-xyz',
    title: 'Trung tâm XYZ',
    industry: 'GIÁO DỤC',
    industryColor: 'blue',
    description: 'Tự động hóa quy trình tuyển sinh',
    image: 'https://images.unsplash.com/photo-1523240795612-9a054b0db644?w=600&q=80',
    metrics: [
      { value: '+150%', label: 'Đăng ký', color: 'blue' },
      { value: '5x', label: 'ROI', color: 'blue' }
    ]
  },
  {
    slug: 'cong-ty-bds-def',
    title: 'Công ty BĐS DEF',
    industry: 'BẤT ĐỘNG SẢN',
    industryColor: 'purple',
    description: 'Giảm 60% chi phí quảng cáo với AI',
    image: 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=600&q=80',
    metrics: [
      { value: '-60%', label: 'Chi phí', color: 'purple' },
      { value: '3x', label: 'Conversion', color: 'purple' }
    ]
  },
  {
    slug: 'chuoi-cua-hang-ghi',
    title: 'Chuỗi Cửa Hàng GHI',
    industry: 'BÁN LẺ',
    industryColor: 'orange',
    description: 'Tối ưu tồn kho với AI Prediction',
    image: 'https://images.unsplash.com/photo-1556761175-5973dc0f32e7?w=600&q=80',
    metrics: [
      { value: '-30%', label: 'Tồn kho', color: 'orange' },
      { value: '2x', label: 'Doanh thu', color: 'orange' }
    ]
  }
];

// Use Content Collection data if available, otherwise use static
const displayCaseStudies = caseStudies.length > 0
  ? caseStudies.map(cs => ({
      slug: cs.slug,
      title: cs.data.client,
      industry: cs.data.industry.toUpperCase(),
      industryColor: getIndustryColor(cs.data.industry),
      description: cs.data.challenge.substring(0, 50) + '...',
      image: cs.data.image,
      metrics: cs.data.results?.slice(0, 2).map((r: any) => ({
        value: r.change,
        label: r.metric,
        color: getIndustryColor(cs.data.industry)
      })) || []
    }))
  : staticCaseStudies;

function getIndustryColor(industry: string): string {
  const colors: Record<string, string> = {
    healthcare: 'green',
    education: 'blue',
    'real-estate': 'purple',
    sme: 'orange',
    other: 'gray'
  };
  return colors[industry] || 'gray';
}
---

<section class="py-16 lg:py-24 bg-section-alt">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-12">
      <span class="inline-block px-3 py-1 bg-green-500/10 text-green-500 text-xs font-semibold rounded-full mb-3">
        CASE STUDIES
      </span>
      <h2 class="text-2xl lg:text-3xl font-bold mb-3">Kết quả thực tế</h2>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      {displayCaseStudies.map((cs) => (
        <div class={`bg-white dark:bg-charcoal-light/50 border border-gray-200 dark:border-white/5 rounded-2xl overflow-hidden hover:border-${cs.industryColor}-500/50 hover:shadow-xl transition-all`}>
          <div class="h-48 overflow-hidden">
            <img
              src={cs.image}
              alt={`Case Study ${cs.title}`}
              class="w-full h-full object-cover hover:scale-105 transition-transform duration-500"
              loading="lazy"
            />
          </div>
          <div class="p-6">
            <span class={`px-3 py-1 bg-${cs.industryColor}-500/10 text-${cs.industryColor}-500 text-xs font-semibold rounded-full`}>
              {cs.industry}
            </span>
            <h3 class="text-xl font-bold mt-4 mb-3">{cs.title}</h3>
            <p class="text-gray-600 dark:text-gray-400 text-sm mb-6">{cs.description}</p>
            <div class="grid grid-cols-2 gap-4 mb-6">
              {cs.metrics.map((metric) => (
                <div>
                  <div class={`text-2xl font-bold text-${metric.color}-500`}>{metric.value}</div>
                  <div class="text-xs text-gray-500">{metric.label}</div>
                </div>
              ))}
            </div>
            <a href={`/case-study/${cs.slug}/`} class="text-bv-red font-semibold text-sm hover:underline">
              Đọc case study →
            </a>
          </div>
        </div>
      ))}
    </div>

    {displayCaseStudies.length === 0 && (
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">Chưa có case study nào.</p>
      </div>
    )}
  </div>
</section>
